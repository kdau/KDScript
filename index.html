<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<link rel="stylesheet" type="text/css" href="gallery.css" />
		<title>KDScript</title>
		<style type="text/css"><!--
			body { font-family: serif; font-size: 11pt; color: #ccc; background-color: #000; margin-left: 5em; }
			a:link, a:visited { color: #99f; text-decoration: none; border-bottom: 1px dotted #99f; }
				a:link:hover, a:visited:hover { border-bottom-style: solid; }
			h1, h2, h3 { clear: both; margin: 1em 0em; font-family: Carleton, serif; font-weight: normal; font-variant: small-caps; }
				h1 { width: 25em; font-size: 28pt; margin-top: 2em; border-bottom: 1px dotted #ccc; }
				h2 { width: 20em; font-size: 20pt; margin-top: 4em; border-bottom: 1px dotted #999; }
				h3 { width: 15em; font-size: 16pt; margin-top: 2em; border-bottom: 1px dotted #333; }
			dl { margin: 2em 5em; width: 60em; padding: 0em; line-height: 150%; border-bottom: 1px dotted #333; font-size: 10pt; }
				dt, dd { border-top: 1px dotted #333; padding-top: 5px; }
					dt { clear: left; float: left; width: 10em; margin: 0em; font-weight: bold; }
					dd { width: 50em; margin: 0.5em 0em 0.5em 10em; }
			p { margin: 1.5em 3em; width: 60em; line-height: 150%; }
			strong, .important { color: #ccf; }
			table { margin: 2em 5em; border-collapse: collapse; font-size: 10pt; }
				caption { font-size: 10pt; font-style: italic; }
				th, td { border: 1px dotted #333; padding: 0.5em 1em; vertical-align: middle; text-align: left; }
					thead th { background-color: #666; color: #000; border-style: solid; }
				col.identifier { width: 15em; }
				col.type { width: 10em; }
				col.description { width: 35em; }
				col.values { width: 25em; }
			ul { margin: 2em; width: 60em; padding: 0em; line-height: 150%;  list-style-type: square; }
				ul.toc, .toc ul { line-height: inherit; }
				ul ul { margin: 0em 0em 1em 1em; }
				li { margin: 1em 4em; }
					.toc li { margin: 0.5em 2em; }
		--></style>
	</head>
	<body>



		<h1>KDScript</h1>
		<p>KDScript is a custom script module for the Dark Engine. It provides access to the new script services available with the unofficial <a href="http://www.ttlg.com/forums/showthread.php?t=141148">NewDark patch</a>, including dynamic weather and fog and nonlinear campaigns. It provides custom HUD elements including quest arrows, statistic meters, and tool sights. It also provides automatic AI/voiceover subtitling and other useful features.</p>
		<p class="important"><strong>This is an alpha/demonstration version only.</strong> The script module is not yet intended for use in missions. The script specifications below may change prior to the final version. For now, if you are interested in using any of these scripts in your mission, please contact me so I can provide updated versions and help you during your testing process.</p>
		<p> This is version <strong>0.1.0.1</strong> of KDScript, released on <strong>2013-07-07</strong> as <code>kdscript&#8209;0.1.0.1.zip</code>. It currently works only with Thief II: The Metal Age patched with NewDark version 1.19 or higher (tested with 1.21 only) on Windows XP or later (or Linux via WINE). Support for Thief: The Dark Project/Thief Gold (with the NewDark patch) may be added in the future.</p>
		<p>Copyright&nbsp;&copy;&nbsp;2012&ndash;2013 Kevin Daughtridge. I am <a href="http://www.ttlg.com/forums/member.php?u=66136">kdau</a> on TTLG and can be reached by email at <code>&lt;kevin&nbsp;AT&nbsp;kdau&nbsp;DOT&nbsp;com&gt;</code>. The script module is licensed under terms of the <a href="http://www.gnu.org/licenses/gpl.html">GNU General Public License</a>. It is provided &ldquo;as is&rdquo; without warranty of any kind, either expressed or implied.</p>
		<p>KDScript is based in part on Public Scripts by <a href="http://dromed.whoopdedo.org/">Tom N. Harris (Telliamed)</a> and includes <code>dh2.osl</code> and lightly modified versions of his <code>lg</code>, <code>DH2</code>, and <code>ScriptLib</code> libraries, which derive in part from earlier work by GayleSaver and Totality. His code is available at his website; mine is included in this archive. Subtitle support is based on <a href="http://www.ttlg.com/forums/showthread.php?t=107554">ideas from Nameless Voice and others</a>.</p>

		<h3 id="demo">Demo mission</h2>
		<p>The included mission demonstrates the scripts in this module. The demo mission may distributed in any way as long as it remains unmodified and I am credited for it. This level was not made and is not supported by Looking Glass Studios or Eidos Interactive. It contains corona designs and textures from the <a href="http://www.ttlg.com/forums/showthread.php?t=141148">NewDark</a> distribution by Le Corbeau and a smoking pipe object by Targa (<a title="Targa's first site" href="http://www.thiefmissions.com/targa/">1</a>, <a title="Targa's second site" href="http://www.grax.org/targa/">2</a>).</p>



		<h2 id="contents">Contents</h2>
		<ul class="toc">
			<li><a href="#history">Version history</a></li>
			<li>Custom HUD elements<ul>
				<li><a href="#KDCustomHUD"><code>KDCustomHUD</code></a></li>
				<li><a href="#KDQuestArrow"><code>KDQuestArrow</code></a></li>
				<li><a href="#KDStatMeter"><code>KDStatMeter</code></a></li>
				<li><a href="#KDToolSight"><code>KDToolSight</code></a></li>
			</ul></li>
			<li>Other NewDark features<ul>
				<li><a href="#KDGetInfo"><code>KDGetInfo</code></a></li>
				<li><a href="#KDTrapEnvMap"><code>KDTrapEnvMap</code></a></li>
				<li><a href="#KDTrapFog"><code>KDTrapFog</code></a></li>
				<li><a href="#KDSyncGlobalFog"><code>KDSyncGlobalFog</code></a></li>
				<li><a href="#KDTrapWeather"><code>KDTrapWeather</code></a></li>
				<li><a href="#KDTrapNextMission"><code>KDTrapNextMission</code></a></li>
			</ul></li>
			<li>Other scripts<ul>
				<li><a href="#KDCarried"><code>KDCarried</code></a></li>
				<li><a href="#KDCarrier"><code>KDCarrier</code></a></li>
				<li><a href="#KDShortText"><code>KDShortText</code></a></li>
				<li><a href="#KDSubtitled"><code>KDSubtitled</code></a></li>
				<li><a href="#KDSubtitledAI"><code>KDSubtitledAI</code></a></li>
				<li><a href="#KDSubtitledVO"><code>KDSubtitledVO</code></a></li>
			</ul></li>
		</ul>



		<h2 id="history">Version history</h2>
		<dl>
			<dt>0.1.0.1</dt><dd>Rebuilt natively on Windows without debug enabled. Included some missing source files. (2013-07-07)</dd>
			<dt>0.1.0</dt><dd>Initial alpha release. (2013-07-06)</dd>
		</dl>



		<h2 id="KDCustomHUD">KDCustomHUD</h2>
		<p><code>KDCustomHUD</code> adds a variety of custom HUD elements to the Dark Engine interface. This script coordinates the drawing of HUD elements; the individual elements and their configuration are defined by other scripts (see below). This script should be placed on the handler object, typically a marker named <code>CustomHUD</code>. It is incompatible with any other NewDark custom HUD provider.</p>
		<p>This script has no parameters of its own. Any parameter of a HUD element script can be set on the handler object as well, providing a default for all instances of that element.</p>
		<p>HUD elements are affected by the <code>d3d_disp_scaled_2d_overlay</code> (scale), <code>d3d_disp_force_filter_scale2d</code> (scaling filter), and <code>d3d_disp_2d_overlay_alpha</code> (opacity) settings in <code>cam_ext.cfg</code>, which can also be placed in <code>dark.cfg</code> for distribution with FMs. If custom HUD elements (such as <code>KDStatMeter</code>) are replacing the light gem and/or health bar, the default versions should be disabled in <code>dark.cfg</code> by setting <code>vismeter_zoom</code> and/or <code>hpbar_zoom</code>, respectively, to <code>0</code>.</p>
		<p>Note that a maximum of 128 HUD-related images can be loaded at a time; animation frames count individually towards this limit.</p>
		<p id="symbols">Some HUD element scripts may be configured to draw line art symbols on screen. For script parameters that define symbols, the following values are possible:</p>
		<dl>
			<dt><code>@none</code></dt><dd>No image or symbol is drawn.</dd>
			<dt><code>@arrow</code></dt><dd>An arrow is drawn, pointing at an appropriate direction (some elements only).</dd>
			<dt><code>@crosshairs</code></dt><dd>Simple crosshairs are drawn.</dd>
			<dt><code>@reticule</code></dt><dd>A reticule with a square and crosshairs is drawn.</dd>
			<dt><code>@square</code></dt><dd>A filled square is drawn.</dd>
		</dl>



		<h2 id="KDQuestArrow">KDQuestArrow</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>quest_arrow</th><td>bool</td><td>whether to initially display the quest arrow</td><td><code>true</code></td></tr>
			<tr><th>quest_arrow_goal</th><td>int</td><td>disable arrow once this objective is completed</td><td><code>-1</code> (none)</td></tr>
			<tr><th>quest_arrow_image</th><td>string</td><td>path to a bitmap image or name of a symbol (see below)</td><td><code>@arrow</code></td></tr>
			<tr><th>quest_arrow_text</th><td>string</td><td>name of a text string or name of a special string (see below)</td><td><code>@name</code></td></tr>
			<tr><th>quest_arrow_color</th><td>color</td><td>color of any symbol or text drawn</td><td><code>#ffffff</code> (white)</td></tr>
			<tr><th>quest_arrow_obscured</th><td>bool</td><td>whether to show the arrow when the object is not visible</td><td><code>false</code></td></tr>
		</tbody></table>
		<p><code>KDQuestArrow</code> displays an image, a symbol, and/or text on screen that tracks the position of the object is is placed on. The arrow might be used to direct the player towards an objective, point out an important area or object, or give brief additional information. It is drawn as a custom HUD element in coordination with the <code>KDCustomHUD</code> script.</p>
		<p>The <code>quest_arrow</code> parameter determines whether the arrow is initially enabled (visible) or not. The arrow can be turned on or off during the mission by sending this object a <code>QuestArrowOn</code> or <code>QuestArrowOff</code> message. If the <code>quest_arrow_goal</code> parameter is set, the arrow is enabled only when the objective is incomplete and visible. Additionally, the arrow is automatically turned off in any of the following events: the object is contained by the player (put in inventory); the object is slain (even if it is not destroyed); the AI object is knocked out.</p>
		<p>The <code>quest_arrow_image</code> parameter determines how the quest arrow appears. If it is set to one of the <a href="#symbols">predefined symbols</a>, the named symbol will be drawn in the color specified in the <code>quest_arrow_color</code> parameter. Otherwise, this parameter should be a relative path to a bitmap image that will represent the arrow. The bitmap should be relatively small but may have a full alpha channel. Animations and context-sensitive choice of images are not yet supported. If the image cannot be loaded, an <code>@arrow</code> will be drawn instead.</p>
		<p>The <code>quest_arrow_text</code> parameter determines what text, if any, is displayed next to the arrow image. This parameter does not contain the text itself; it is either one of the special values listed below or the name of a string in the <code>strings\hud.str</code> file. The text will be drawn in the <code>intrface\textfont.fon</code> font and the color specified in the <code>quest_arrow_color</code> parameter.</p>
		<dl>
			<dt><code>@none</code></dt><dd>No text is displayed (image only).</dd>
			<dt><code>@name</code></dt><dd>The object's name, as defined in the <code>Inventory\Object Name</code> property, is displayed.</dd>
			<dt><code>@description</code></dt><dd>The object's description, as defined in the <code>Inventory\Long Description</code> property, is displayed.</dd>
			<dt><code>@objective</code></dt><dd>The short description of the objective identified in the <code>quest_arrow_goal</code> parameter is displayed.</dd>
		</dl>
		<p>By default, the quest arrow will only be drawn if the player can see the object. If the <code>quest_arrow_obscured</code> parameter is <code>true</code>, the arrow will be displayed even if the object is not visible (obscured by other objects or terrain). The direction of the object still must be within the player's current field of view.</p>
		<p>This script <em>requires</em> that a handler object have the <code>KDCustomHUD</code> script (see above). If there is a <code>ScriptParams</code> link with the data <code>CustomHUD</code> from this object, its target must be the handler object; otherwise, the handler object must be named <code>CustomHUD</code>. Any of the parameters for this script may also be set on the handler object; the values there will be used as defaults for all quest arrows.</p>



		<h2 id="KDStatMeter">KDStatMeter</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
			<tr><th>stat_meter</th><td>bool</td><td>whether to initially display the stat meter</td><td><code>true</code></td></tr>
			<tr><th>stat_meter_style</th><td>string</td><td>the style of meter to draw (see below)</td><td><code>progress</code></td></tr>
			<tr><th>stat_meter_position</th><td>string</td><td>where to draw the display on screen (see below)</td><td><code>nw</code></td></tr>
			<tr><th>stat_meter_orient</th><td>string</td><td>how the meter is arranged (see below)</td><td><code>horiz</code></td></tr>
			<tr><th>stat_meter_image</th><td>string</td><td>path to a bitmap image or name of a symbol (see below)</td><td><code>@square</code></td></tr>
			<tr><th>stat_meter_width</th><td>int</td><td>the width of the meter or unit, in pixels</td><td>(see below)</td></tr>
			<tr><th>stat_meter_height</th><td>int</td><td>the height of the meter or unit, in pixels</td><td>(see below)</td></tr>
			<tr><th>stat_meter_spacing</th><td>int</td><td>space between units of the meter, in pixels</td><td><code>8</code></td></tr>
			<tr><th>stat_source_qvar</th><td>string</td><td>which quest variable to use as the statistic</td><td>&mdash;</td></tr>
			<tr><th>stat_source_property</th><td>string</td><td>which property to use as the statistic</td><td>&mdash;</td></tr>
			<tr><th>stat_source_field</th><td>string</td><td>which field within a property to use</td><td>&mdash;</td></tr>
			<tr><th>stat_source_component</th><td>string</td><td>which component of a vector property/field to use</td><td>&mdash;</td></tr>
			<tr><th>stat_source_object</th><td>string</td><td>which object to use for a property</td><td>(self)</td></tr>
			<tr><th>stat_range_min</th><td>float</td><td>the lowest possible value of the statistic</td><td><code>0.0</code></td></tr>
			<tr><th>stat_range_max</th><td>float</td><td>the highest possible value of the statistic</td><td><code>1.0</code></td></tr>
			<tr><th>stat_range_low</th><td>int</td><td>the percentage at or below which a value is considered low</td><td><code>25</code></td></tr>
			<tr><th>stat_range_high</th><td>int</td><td>the percentage at or above which a value is considered high</td><td><code>75</code></td></tr>
			<tr><th>stat_color_bg</th><td>color</td><td>color of the meter's background area</td><td><code>0x000000</code> (black)</td></tr>
			<tr><th>stat_color_low</th><td>color</td><td>color of the meter's content if its value is low</td><td><code>0xff0000</code> (red)</td></tr>
			<tr><th>stat_color_med</th><td>color</td><td>color of the meter's content if its value is medium</td><td><code>0xffff00</code> (yellow)</td></tr>
			<tr><th>stat_color_high</th><td>color</td><td>color of the meter's content if its value is high</td><td><code>0x00ff00</code> (green)</td></tr>
		<tbody>
		</tbody></table>
		<p><code>KDStatMeter</code> displays a meter (bar, gem, or other indicator) on screen that reflects the value of a numeric property, quest variable, or other setting. The meter might be used to display health, visibility, alertness, etc. of the player or an AI; time elapsed or remaining; progress towards an objective; or any other numeric value.
		<p>The <code>stat_meter</code> parameter determines whether the meter is initially enabled (visible) or not. The meter can be turned on or off during the mission by sending this object a <code>StatMeterOn</code> or <code>StatMeterOff</code> message.</p>
		<h3>Appearance of meter</h3>
		<p>The <code>stat_meter_style</code> parameter determines what visual style of meter is drawn, from among these values:</p>
		<dl>
			<dt><code>progress</code></dt><dd>A progress bar is drawn that is gradually filled based on the statistic.</dd>
			<dt><code>units</code></dt><dd>A number of individual images or symbols are drawn based on the statistic.</dd>
			<dt><code>gem</code></dt><dd>A solid area is drawn whose image or color changes based on the statistic.</dd>
		</dl>
		<p>The <code>stat_meter_position</code> parameter determines where on the screen the meter is drawn, from among these values:</p>
		<dl>
			<dt><code>center</code></dt><dd>The meter is drawn in the center of the screen.</dd>
			<dt><code>north</code>, <code>south</code>, <code>east</code>, <code>west</code></dt><dd>The meter is drawn at the center of the specified edge of the screen (where <code>north</code> is up, <code>west</code> is left, etc.).</dd>
			<dt><code>nw</code>, <code>se</code>, <code>sw</code>, <code>se</code><dd>The meter is drawn at the specified corner of the screen.</dd>
		</dl>
		<p>The <code>stat_meter_orient</code> parameter determines how a <code>progress</code> or <code>units</code> meter is arranged, from among these values:</p>
		<dl>
			<dt><code>horiz</code></dt><dd>A horizontal progress bar or series of units is drawn. For elements at the left of the screen, higher values are towards the right; for those on the right, towards the left.</dd>
			<dt><code>vert</code></dt><dd>A vertical progress bar or series of units is drawn. For elements at the bottom of the screen, higher values are towards the top; for those on the top, towards the bottom.</dd>
		</dl>
		<p>The <code>stat_meter_image</code> parameter determines a bitmap image or symbol to use in drawing the meter. For a <code>units</code> meter, if it is set to one of the <a href="#symbols">predefined symbols</a> (other than <code>@arrow</code>), the named symbol will be drawn as the unit. Otherwise, this parameter should be set to a relative path to a bitmap image that will be drawn as the unit. If the image cannot be loaded, a standard meter will be drawn instead. The default value for <code>units</code> meters is <code>@square</code>.</p>
		<p>For a <code>gem</code> meter, the <code>stat_meter_image</code> may be a relative path to the first of a series of bitmap frames in the usual Dark Engine naming pattern (e.g. <code>meter.png</code>, <code>meter_1.png</code>, <code>meter_2.png</code>, etc.). The frame displayed will be based on the value of the statistic, with the first frame representing the lowest values and the last frame the highest. All frames should be the same size, as only the size of the first frame will be checked.</p>
		<p>Images are not yet supported for <code>progress</code> meters, but a similar effect can be obtained with the <code>gem</code> style.</p>
		<p>The <code>stat_meter_width</code> and <code>stat_meter_height</code> parameters determine the width and height, respectively, of a <code>progress</code> or <code>gem</code> meter or of a single unit of a <code>units</code> meter. If a bitmap image is specified in <code>stat_meter_image</code>, these parameters are ignored. Otherwise, they default to <code>32</code>&times;<code>32</code> for <code>units</code> meters and <code>128</code>&times;<code>32</code> for all others.</p>
		<p>For <code>units</code> meters, the <code>stat_meter_spacing</code> parameter determines the space in pixels left between each unit image or symbol.</p>
		<h3>The source statistic</h3>
		<p>The statistic displayed by the meter can be sourced from either an object property or a quest variable.</p>
		<p>The <code>stat_source_qvar</code> parameter names a quest variable that provides the statistic. The variable may be set at mission or campaign level.</p>
		<p>The <code>stat_source_property</code> parameter names a property that provides the statistic. Use an internal Dark Engine property name (e.g. <code>PhysState</code> for <code>Physics\Model\State</code>); these can be found using the <code>list_props</code> command (<em>Log&rarr;Dump&nbsp;property&nbsp;list</em>).</p>
		<p>The <code>stat_source_field</code> parameter names the field within a property that provides the statistic. This parameter may only be and must be set if <code>stat_source_property</code> names a property with more than one field. The field name should be exactly as it appears in the property dialog (e.g. <code>Rot Velocity</code> within the <code>PhysState</code> property).</p>
		<p>The <code>stat_source_component</code> parameter names the component of a vector value that provides the statistic. This parameter may only be and must be set if the property/field providing the statistic is a vector (has three values in a row). This parameter should then be set to <code>x</code>, <code>y</code>, or <code>z</code> (first, second, or third value, respectively).</p>
		<p>The <code>stat_source_object</code> parameter determines the object that provides a property statistic. It may be an object name or an object number, though the former is recommended. This parameter may only be set if <code>stat_source_property</code> is set; its default is the object on which this script is placed.</p>
		<h3>Range and coloration</h3>
		<p>Several aspects of the meter depend on where the statistic value falls within a range of possible values.</p>
		<p>The <code>stat_range_min</code> and <code>stat_range_max</code> parameters determine the lowest and highest possible values, respectively, of the statistic. These are used to convert the statistic to a percentage.</p>
		<p>The <code>stat_range_low</code> parameter is a percentage (between minimum and maximum values) threshold at or below which the statistic value is considered to be low. Likewise, the value is considered high if its percentage is at or above The <code>stat_range_high</code>. These determine when to display the meter with special coloring/imagery.</p>
		<p>For <code>progress</code> and <code>units</code> meters, the foreground elements of the meter (progress bar, unit symbols, border, and text) are colored based on where the current value falls within the range: low (<code>stat_color_low</code>), medium (<code>stat_color_med</code>), or high (<code>stat_color_high</code>). The <code>stat_color_bg</code> parameter defines the color of background elements of the meter.</p>
		<p>For <code>gem</code> meters, color is handled differently: the color smoothly transitions from the low color to the medium color to the high color based on the statistic value, while the background color is used for a border.</p>



		<h2 id="KDToolSight">KDToolSight</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
			<tr><th>tool_sight_image</th><td>string</td><td>path to a bitmap image or name of a symbol (see below)</td><td><code>@crosshairs</code></td></tr>
			<tr><th>tool_sight_color</th><td>color</td><td>color of any symbol or text drawn</td><td><code>#808080</code> (grey)</td></tr>
		<tbody>
		</tbody></table>
		<p><code>KDToolSight</code> displays an image or symbol at the center of the canvas (screen) when the object is is placed on is selected in inventory. It is intended to help the player target thrown tools and non-bow projectiles, primarily that have little or no gravity (such as magic spells). It is drawn as a custom HUD element in coordination with the <code>KDCustomHUD</code> script.</p>
		<p>The <code>tool_sight_image</code> parameter determines how the tool sight appears. If it is set to one of the <a href="#symbols">predefined symbols</a> (other than <code>@arrow</code>), the named symbol will be drawn in the color specified in the <code>tool_sight_color</code> parameter. Otherwise, this parameter should be a relative path to a bitmap image that will represent the arrow. The bitmap should be relatively small but may have a full alpha channel. Animations and context-sensitive choice of images are not yet supported. If the image cannot be loaded, <code>@crosshairs</code> will be drawn instead.</p>
		<p>This script <em>requires</em> that a handler object have the <code>KDCustomHUD</code> script (see above). If there is a <code>ScriptParams</code> link with the data <code>CustomHUD</code> from this object, its target must be the handler object; otherwise, the handler object must be named <code>CustomHUD</code>. Any of the parameters for this script may also be set on the handler object; the values there will be used as defaults for all tool sights.</p>



		<h2 id="KDGetInfo">KDGetInfo</h2>
		<p>Every time the mission is started/loaded or enters game mode (returns from a menu), <code>KDGetInfo</code> populates a number of mission quest variables with information about the game environment. These values are available at Sim time and can be tracked by <code>TrigQVar</code>. They are deleted as the script unloads, to prevent them from being stored with the mission in DromEd.</p>
		<table>
			<colgroup><col class="identifier"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Quest variable</th><th>Description</th><th>Values</th></tr></thead>
		<tbody>
			<tr><th>info_directx_version</th><td>the DirectX version in use</td><td><code>6</code> = old, <code>9</code> = new</td></tr>
			<tr><th>info_display_height</th><td>the height of the drawing area (screen/window)</td><td>e.g. <code>1080</code> for fullscreen 1920&times;1080</td></tr>
			<tr><th>info_display_width</th><td>the height of the drawing area (screen/window)</td><td>e.g. <code>1920</code> for fullscreen 1920&times;1080</td></tr>
			<tr><th>info_has_eax</th><td>whether EAX is enabled</td><td><code>1</code> = yes, <code>0</code> = no</td></tr>
			<tr><th>info_has_fog</th><td>whether fogging is enabled</td><td><code>1</code> = yes, <code>0</code> = no</td></tr>
			<tr><th>info_has_hw3d</th><td>whether hardware 3D rendering is enabled</td><td><code>1</code> = yes, <code>0</code> = no</td></tr>
			<tr><th>info_has_sky</th><td>whether NewSky (&ldquo;high detail&rdquo;/&ldquo;enhanced&rdquo; sky) is enabled</td><td><code>1</code> = yes, <code>0</code> = no</td></tr>
			<tr><th>info_has_weather</th><td>whether weather is enabled</td><td><code>1</code> = yes, <code>0</code> = no</td></tr>
			<tr><th>info_mission</th><td>the number of the current mission</td><td>e.g. <code>20</code> for miss20</td></tr>
			<tr><th>info_mode</th><td>the current engine mode</td><td><code>0</code> = regular game mode (e.g. thief2.exe)<br/><code>1</code> = editor (e.g. dromed.exe) in edit mode<br/><code>2</code> = editor in game mode</td></tr>
			<tr><th>info_version_major</th><td>the major component of the engine version</td><td>e.g. <code>1</code> for version 1.21</td></tr>
			<tr><th>info_version_minor</th><td>the minor component of the engine version</td><td>e.g. <code>21</code> for version 1.21</td></tr>
		</tbody></table>



		<h2 id="KDTrapEnvMap">KDTrapEnvMap</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>env_zone</th><td>integer</td><td>zone to change the texture for (<code>0</code>&ndash;<code>63</code>)</td><td><code>0</code> (global)</td></tr>
			<tr><th>env_map_on</th><td>string</td><td>envmap texture to set when turned on</td><td>&mdash;</td></tr>
			<tr><th>env_map_off</th><td>string</td><td>envmap texture to set when turned off</td><td>&mdash;</td></tr>
		</tbody></table>
		<p>When triggered, <code>KDTrapEnvMap</code> changes the texture associated with an environment zone. If the <code>env_zone</code> parameter is <code>0</code>, the global texture is changed. (The default textures, both global and per zone, are defined in the <em>Mission&nbsp;Variables&nbsp;&rarr;&nbsp;Environment&nbsp;Maps</em> dialog. See the NewDark documentation for more details on environment maps and reflective materials.)</p>
		<p>When turned on, sets the texture for the specified zone to the value of the <code>env_map_on</code> parameter, if defined; when turned off, sets it to <code>env_map_off</code>, if defined. Values should be specified as relative paths, e.g. <code>tex\envmaps\hallway</code>. The usual trap control flags, locking, and timing are respected.</p>



		<h2 id="KDTrapFog">KDTrapFog</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>fog_zone</th><td>integer</td><td>zone to change the fog for (<code>0</code>&ndash;<code>8</code>)</td><td><code>0</code> (global)</td></tr>
			<tr><th>fog_color_on</th><td>color</td><td>color of fog to set when turned on</td><td>&mdash;</td></tr>
			<tr><th>fog_dist_on</th><td>real</td><td>distance (in feet) of fog to set when turned on</td><td>&mdash;</td></tr>
			<tr><th>fog_color_off</th><td>color</td><td>color of fog to set when turned off</td><td>&mdash;</td></tr>
			<tr><th>fog_dist_off</th><td>real</td><td>distance (in feet) of fog to set when turned off</td><td>&mdash;</td></tr>
			<tr><th>transition</th><td>time</td><td>length of transition between states, in milliseconds</td><td><code>0</code></td></tr>
		</tbody></table>
		<p>When triggered, <code>KDTrapFog</code> changes the color and distance of fog for the specified fog zone. If the <code>fog_zone</code> parameter is <code>0</code> or undefined, the global fog is changed. (The initial fog, both global and per zone, is defined in the <em>Mission&nbsp;Variables&nbsp;&rarr;&nbsp;Fog&nbsp;Zones</em> dialog.)</p>
		<p>When turned on, sets the fog color and distance for the specified zone to the values of the <code>fog_color_on</code> and <code>fog_dist_on</code> parameters, respectively. If the color is undefined or black (<code>#000000</code>), it will not be changed. If the distance is undefined or less than zero, it will not be changed. If the distance is zero (<code>0.0</code>), fog is turned off completely; transitions to and from turned-off fog are handled correctly. When turned off, sets the fog color and distance to <code>fog_color_off</code> and <code>fog_dist_off</code>, with the same caveats.</p>
		<p>The <code>transition</code> parameter specifies the length, in milliseconds, of the transition between the old and new values. If that parameter is undefined or set to <code>0</code>, the transition will be instantaneous. The usual trap control flags, locking, and timing (before the start of the transition, not its length) are respected.</p>



		<h2 id="KDSyncGlobalFog">KDSyncGlobalFog</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>sync_fog_color</th><td>bool</td><td>whether to synchronize global and zonal fog color</td><td><code>true</code></td></tr>
			<tr><th>sync_fog_dist</th><td>bool</td><td>whether to synchronize global and zonal fog distance</td><td><code>true</code></td></tr>
			<tr><th>fog_dist_mult</th><td>float</td><td>value to multiply zonal fog distance by</td><td><code>1.0</code></td></tr>
			<tr><th>fog_dist_add</th><td>float</td><td>value to add to zonal fog distance after multiplication</td><td><code>0.0</code></td></tr>
			<tr><th>transition</th><td>time</td><td>length of transition between states, in milliseconds</td><td><code>0</code></td></tr>
		</tbody></table>
		<p>When placed on the Player object (via the starting point), <code>KDSyncGlobalFog</code> keeps the color and/or distance of the global fog synchronized with that of the current room's fog zone. Since only global fog can apply to the various NewSky layers, this allows the sky fog to match the (near-)ground fog. (The initial fog, both global and per zone, is defined in the <em>Mission&nbsp;Variables&nbsp;&rarr;&nbsp;Fog&nbsp;Zones</em> dialog.)</p>
		<p>If the <code>sync_fog_color</code> parameter is <code>true</code>, the fog color will be synchronized; if <code>sync_fog_dist</code> is true, the fog distance will be synchronized. The fog distance used globally is equal to the zonal fog distance, multiplied by <code>fog_dist_mult</code>, added to <code>fog_dist_add</code>. Regardless of these settings, global fog will be turned off in rooms where fog is disabled or zones where fog is off (zero distance). The <code>transition</code> parameter specifies the length, in milliseconds, of the transition between the old and new values. If that parameter is undefined or set to <code>0</code>, the transition will be instantaneous.</p>
		<p>Since this script continuously alters the global fog settings, no room in a mission using this script should be set to use global fog; use the zones (1&ndash;8) only. This script <em>is</em> compatible with <code>KDTrapFog</code> (see above) when its <code>fog_zone</code> parameter is not <code>0</code>; that script will notify this one automatically of changes. This script is <em>not</em> compatible, of course, with <code>KDTrapFog</code> with a <code>fog_zone</code> of <code>0</code> (global).</p>



		<h2 id="KDTrapWeather">KDTrapWeather</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>precip_freq_on</th><td>real</td><td>frequency (drops/sec) of precipitation to set when turned on</td><td>&mdash;</td></tr>
			<tr><th>precip_speed_on</th><td>real</td><td>speed (ft/sec) of precipitation to set when turned on</td><td>&mdash;</td></tr>
			<tr><th>precip_freq_off</th><td>real</td><td>frequency (drops/sec) of precipitation to set when turned off</td><td>&mdash;</td></tr>
			<tr><th>precip_speed_off</th><td>real</td><td>speed (ft/sec) of precipitation to set when turned off</td><td>&mdash;</td></tr>
			<tr><th>transition</th><td>time</td><td>length of transition between states, in milliseconds</td><td><code>0</code></td></tr>
		</tbody></table>
		<p>When triggered, <code>KDTrapWeather</code> changes the frequency and speed of precipitation (weather). The frequency is expressed in number of new drops per second, while the speed is expressed in feet per second. (The default weather, including a number of other values, is defined in the <em>Mission&nbsp;Variables&nbsp;&rarr;&nbsp;Weather</em> dialog.)</p>
		<p>When turned on, sets the precipitation frequency and speed to the values of the <code>precip_freq_on</code> and <code>precip_speed_on</code> parameters, respectively. If either is not defined or is less than zero, it will not be changed. If the defined frequency is zero (<code>0.0</code>), precipitation will be turned off completely. When turned off, sets the precipitation frequency and speed to <code>precip_freq_off</code> and <code>precip_speed_off</code>, with the same caveats.</p>
		<p>The <code>transition</code> parameter specifies the length, in milliseconds, of the transition between the old and new values. If that parameter is undefined or set to <code>0</code>, the transition will be instantaneous. The usual trap control flags, locking, and timing (before the start of the transition, not its length) are respected.</p>



		<h2 id="KDTrapNextMission">KDTrapNextMission</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>next_mission_on</th><td>integer</td><td>mission number to set as next when turned on</td><td>&mdash;</td></tr>
			<tr><th>next_mission_off</th><td>integer</td><td>mission number to set as next when turned off</td><td>&mdash;</td></tr>
		</tbody></table>
		<p>When triggered, <code>KDTrapNextMission</code> changes which mission will begin after the current mission ends. (By default, the next mission is the mission specified in <code>strings\missflag.str</code> in the <code>miss_X_next</code> value [where <code>X</code> is the current mission], or else one mission past the current mission.) When turned on, sets the next mission to the value of the <code>next_mission_on</code> parameter, if defined; when turned off, sets it to <code>next_mission_off</code>. The usual trap control flags, locking, and timing are respected.</p>
		<p><strong>Important:</strong> The engine does not perform any validation on mission numbers. If the next mission is set to a nonexistent mission, the game will crash as soon as it tries to load it. If the chosen mission has the <code>skip</code> flag set, it will still be skipped; for example, choosing <code>3</code> (the cancelled museum mission) in Thief II will load mission 4 (<em>Framed</em>). If the mission calling this script has the <code>end</code> flag set, this script will have no effect as the campaign will end after this mission regardless.</p>



		<h2 id="KDCarried">KDCarried</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
			<tr><th>drop_on_alert</th><td>int</td><td>minimum AI alert level to cause drop</td><td><code>0</code> (don't drop on alert)</td></tr>
			<tr><th>inert_until_dropped</th><td>bool</td><td>whether the object should be <code>FrobInert</code> while carried</td><td><code>false</code></td></tr>
			<tr><th>off_when_dropped</th><td>bool</td><td>whether to turn off the object when dropped</td><td><code>false</code></td></tr>
		<tbody>
		</tbody></table>
		<p><code>KDCarried</code> manages physical objects that are carried or worn by AIs, but are dropped when appropriate. If and when this script receives the <code>Drop</code> message, it will remove any links between its object and the AI and cause its object to drop (deadfall). Objects with this script should be linked to an AI having the <code>KDCarrier</code> script (see below) in one of the following ways:</p>
		<ul>
			<li>a <code>Contains</code> link of type <code>Alternate</code> or <code>Belt</code> from the AI to the object (The pickable pocket count will be decremented if the link is broken.)</li>
			<li>a <code>CreatureAttachment</code> link from the AI to the object</li>
			<li>a <code>DetailAttachement</code> link from the object to the AI (The new-to-NewDark <code>DetailAttachement</code> link only supports non-physical objects, but offers more flexible relative positioning. Due to a technical limitation, a clone of the object will be dropped while the original is destroyed. As with cloning in DromEd, links are not preserved.)</li>
		</ul>
		<p>If the object is non-physical, this script will create a physics model for it before dropping it.</p>
		<p>If the carrier AI is slain or knocked out, the <code>KDCarrier</code> script on the AI will send this script the <code>CarrierBrainDead</code> message. In response, the object will be unlinked from the AI and dropped.</p>
		<p>If the carrier AI is alerted, the <code>KDCarrier</code> script will send this script a <code>CarrierAlerted</code> message. If the <code>drop_on_alert</code> parameter is greater than <code>0</code> but less than or equal to the new alert level, the object will be unlinked from the AI and dropped.</p>
		<p>If the <code>inert_until_dropped</code> parameter is <code>true</code>, this script will add the <code>FrobInert</code> metaproperty to its object on <code>Sim</code> (or <code>Create</code> for dynamically created objects) and remove it when the object is dropped.</p>
		<p>If the <code>off_when_dropped</code> parameter is <code>true</code>, when this script drops the object it will send the <code>TurnOff</code> message to the object itself and along any <code>ControlDevice</code> links from the object.</p>



		<h2 id="KDCarrier">KDCarrier</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
			<tr><th>create_attachments</th><td>bool</td><td>whether to create <code>CreatureAttachment</code>-linked objects</td><td><code>true</code></td></tr>
		<tbody>
		</tbody></table>
		<p><code>KDCarrier</code> supports the <code>KDCarried</code> script (see above) by sending messages from the AI it is placed on to objects carried or worn by that AI. If the AI is slain or knocked out, this script will send the <code>CarrierBrainDead</code> message. If the AI is alerted, this script will send the <code>CarrierAlerted</code> message with the data set to the new alert level. Objects linked from this AI with <code>Contains</code>, <code>CreatureAttachment</code>, and <code>~DetailAttachement</code> links receive these messages.</p>
		<p>If the <code>create_attachments</code> parameter is <code>true</code>, <code>KDCarrier</code> also allows <code>CreatureAttachment</code> links to be placed on archetypes. When an object is created whose archetype has <code>KDCarrier</code>, objects will automatically be created and attached according to any inherited <code>CreatureAttachment</code> links. They will also be created at <code>Sim</code>. An object will only be created if the specified joint is available (has no other objects linked to it), so a link in a child archetype may override one in a parent. (This is similar in effect to <code>NVAttachMyObj</code>, but does not require any special parameters or <code>ScriptParams</code> links.)



		<h2 id="KDShortText">KDShortText</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
		<tbody>
			<tr><th>text</th><td>string</td><td>name of the message from short.str to display<br/>(if the <code>Book\Text</code> property is not set)</td><td>&mdash;</td></tr>
			<tr><th>text_color</th><td>color</td><td>color to display the message in</td><td><code>0xffffff</code> (white)</td></tr>
			<tr><th>text_time</th><td>time</td><td>how long to display the message, in milliseconds</td><td>(calculated based on message length)</td></tr>
			<tr><th>text_on_frob</th><td>bool</td><td>whether to display the message when frobbed (clicked)</td><td><code>true</code></td></tr>
			<tr><th>text_on_focus</th><td>bool</td><td>whether to display the message when focused (highlighted)</td><td><code>true</code></td></tr>
		</tbody></table>
		<p>When frobbed and/or focused, <code>KDShortText</code> displays text in an on-screen message of the specified color for the specified duration. The <code>Book\Text</code> property, if present, gives the name of a message in the <code>strings\short.str</code> file; otherwise, the <code>text</code> parameter gives the name of the message. This structure allows for cleaner updating and translation of short readables without requiring a separate <code>.str</code> file for each.</p>
		<p>If the <code>text_on_frob</code> parameter is <code>true</code> and the <code>WorldAction</code> of the object's <code>Engine Features\FrobInfo</code> property includes <code>Script</code>, the message will be displayed when the object is frobbed (clicked). If <code>text_on_focus</code> is <code>true</code> and the <code>WorldAction</code> includes <code>FocusScript</code>, the message will be displayed when the object is focused (highlighted/pointed to).</p>



		<h2 id="KDSubtitled">KDSubtitled</h2>
		<table>
			<colgroup><col class="identifier"/><col class="type"/><col class="description"/><col class="values"/></colgroup>
			<thead><tr><th>Parameter</th><th>Type</th><th>Description</th><th>Default value</th></tr></thead>
			<tr><th>subtitle_color</th><td>color</td><td>the color to display the subtitle in</td><td><code>0xffffff</code> (white)</td></tr>
		<tbody>
		</tbody></table>
		<p><code>KDSubtitled</code> is the base script for <code>KDSubtitledAI</code> and <code>KDSubtitledVO</code>. It cannot be used directly.</p>
		<p>Subtitles are taken from the <code>strings\subtitles.str</code> file, where they are identified by schema name; if no subtitle is present for a schema, nothing will be shown. In addition to the trigger for each script below, a subtitle can be displayed by sending the script a <code>Subtitle</code> message whose data is the object number of the schema.</p>
		<p>By default, subtitles are displayed like other onscreen text in the top center of the screen. If the <code>subtitles_use_hud</code> quest variable is set to <code>1</code> and a handler object has the <code>KDCustomHUD</code> script (see above), subtitles will be displayed as HUD elements instead. These are individual boxes of text that track the position of the speaker and do not overwrite each other or other text. If there is a <code>ScriptParams</code> link with the data <code>CustomHUD</code> from this object, its target should be the handler object; otherwise, the handler object should be named <code>CustomHUD</code>.</p>
		<p>The subtitle is displayed in <code>subtitle_color</code>, which may be set either on the schema object (takes priority) or another relevant object (see below). If the <code>Script\Timing</code> property is set on the schema object, it determines how long, in milliseconds, the subtitle is displayed; otherwise, an appropriate length is calculated based on the text.</p>



		<h2 id="KDSubtitledAI">KDSubtitledAI</h2>
		<p>When the AI it is placed on plays a speech schema, <code>KDSubtitledAI</code> displays a subtitle for that schema on screen. Its base script is <code>KDSubtitled</code>; see above for more details.</p>
		<p>The <code>subtitle_color</code> parameter may be set on the AI itself, as a default for all the AI's speech schemas.</p>
		<p>For convenience, this script can be placed on the <code>Creature</code> archetype to be inherited by all AI. (Any AI archetype or instance with the &ldquo;Don't Inherit&rdquo; option on its <code>Scripts</code> property would need to re-add the script to use it. In the stock Thief&nbsp;II <code>dark.gam</code>, these are <code>Rat</code>, <code>ScurryBot</code>, and <code>Phantom</code>.)</p>



		<h2 id="KDSubtitledVO">KDSubtitledVO</h2>
		<p>When the <code>VOTrap</code> (or other trap with a <code>SoundDescription</code> link) it is placed on is turned on, <code>KDSubtitledVO</code> displays a subtitle for the linked schema on screen. There should only be one <code>SoundDescription</code> link from the object. The subtitle for a schema will only be displayed once in a mission, like the schema itself. This script's base script is <code>KDSubtitled</code>; see above for more details.</p>
		<p>The <code>subtitle_color</code> parameter may be set on the <code>Player</code> object (via the starting point or the <code>Garrett</code> archetype), as a default for all voiceover schemas.</p>
		<p>For convenience, this script can be placed on the <code>VOTrap</code> archetype to be inherited by all voiceovers.</p>



	</body>
</html>

